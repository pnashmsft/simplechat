{% extends "base.html" %}
{% block title %}Admin Settings - {{ app_settings.app_title }}{% endblock %}

{% block content %}
<div class="container">
    <h2>Admin Settings</h2>
    <form method="post" enctype="multipart/form-data">
        <p class="text-muted">Use this form to configure the administrative settings for your application.</p>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary mt-3 mb-3">Save Settings</button>

        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="adminSettingsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab"
                        data-bs-toggle="tab" data-bs-target="#general"
                        type="button" role="tab" aria-controls="general" aria-selected="true">
                    General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gpt-tab"
                        data-bs-toggle="tab" data-bs-target="#gpt"
                        type="button" role="tab" aria-controls="gpt" aria-selected="false">
                    GPT
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="embeddings-tab"
                        data-bs-toggle="tab" data-bs-target="#embeddings"
                        type="button" role="tab" aria-controls="embeddings" aria-selected="false">
                    Embeddings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="image-gen-tab"
                        data-bs-toggle="tab" data-bs-target="#image-gen"
                        type="button" role="tab" aria-controls="image-gen" aria-selected="false">
                    Image Generation
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="web-search-tab"
                        data-bs-toggle="tab" data-bs-target="#web-search"
                        type="button" role="tab" aria-controls="web-search" aria-selected="false">
                    Web Search
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="external-apis-tab"
                        data-bs-toggle="tab" data-bs-target="#external-apis"
                        type="button" role="tab" aria-controls="external-apis" aria-selected="false">
                    External APIs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-tab"
                        data-bs-toggle="tab" data-bs-target="#other"
                        type="button" role="tab" aria-controls="other" aria-selected="false">
                    Other
                </button>
            </li>
        </ul>

        <!-- Tab Panes -->
        <div class="tab-content mt-3" id="adminSettingsTabContent">

            <!-- GENERAL TAB -->
            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                <p class="text-muted">
                    Configure general application settings, including the applicationâ€™s title, logo, and landing page text.
                </p>
                <div class="card p-3 mb-3">
                    <div class="mb-3">
                        <label for="app_title" class="form-label">Application Title</label>
                        <input type="text" class="form-control" id="app_title" name="app_title"
                               value="{{ settings.app_title }}">
                    </div>
                    <h5 class="mt-3">Logo Settings</h5>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" id="show_logo" name="show_logo"
                               {% if settings.show_logo %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="show_logo">Show Logo</label>
                    </div>
                    <div class="form-group mb-3">
                        <label for="logo_file">Upload Custom Logo</label>
                        <input type="file" class="form-control" name="logo_file" id="logo_file" accept=".png,.jpg,.jpeg">
                    </div>
                </div>
                <div class="card p-3">
                    <label for="landing_page_text" class="form-label">Landing Page Text (Markdown Supported)</label>
                    <textarea class="form-control" id="landing_page_text" name="landing_page_text"
                              rows="3">{{ settings.landing_page_text }}</textarea>
                </div>
            </div>

            <!-- GPT TAB -->
            <div class="tab-pane fade" id="gpt" role="tabpanel" aria-labelledby="gpt-tab">
                <p class="text-muted">
                    Configure your GPT model settings. These are used for generating AI text responses.
                </p>

                <!-- CHANGE: Enable APIM switch at the top of the GPT tab -->
                <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" id="enable_gpt_apim" name="enable_gpt_apim"
                           {% if settings.enable_gpt_apim %}checked{% endif %}>
                    <label class="form-check-label" for="enable_gpt_apim">Enable APIM</label>
                </div>
                <!-- /CHANGE -->

                <!-- CHANGE: Wrap the original GPT Azure OpenAI fields in a container that hides when APIM is enabled -->
                <div id="non_apim_gpt_settings" {% if settings.enable_gpt_apim %}style="display: none;"{% endif %}>
                    <div class="card p-3 mb-3">
                        <div class="mb-3">
                            <label for="azure_openai_gpt_endpoint" class="form-label">
                                Azure OpenAI GPT Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_gpt_endpoint"
                                   name="azure_openai_gpt_endpoint"
                                   value="{{ settings.azure_openai_gpt_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_gpt_authentication_type"
                                    name="azure_openai_gpt_authentication_type">
                                <option value="key" 
                                    {% if settings.azure_openai_gpt_authentication_type=='key' %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity"
                                    {% if settings.azure_openai_gpt_authentication_type=='managed_identity' %}selected{% endif %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_subscription_id" class="form-label">Subscription ID</label>
                            <input type="text" class="form-control" id="azure_openai_gpt_subscription_id"
                                   name="azure_openai_gpt_subscription_id"
                                   value="{{ settings.azure_openai_gpt_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_gpt_resource_group"
                                   name="azure_openai_gpt_resource_group"
                                   value="{{ settings.azure_openai_gpt_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="gpt_key_container"
                             {% if settings.azure_openai_gpt_authentication_type != 'key' %}style="display: none;"{% endif %}>
                            <label for="azure_openai_gpt_key" class="form-label">Azure OpenAI GPT Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_gpt_key"
                                       name="azure_openai_gpt_key"
                                       value="{{ settings.azure_openai_gpt_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary" id="toggle_gpt_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="gpt_models_list" class="mt-2 mb-3">
                                <!-- Dynamically show the "all" models returned from /api/models/gpt -->
                            </div>
                            <!-- Hidden input that will store the final "selected" GPT JSON -->
                            <input type="hidden" name="gpt_model_json" id="gpt_model_json" />

                            <!-- Also hidden input for the actual selected deployment name -->
                            <input type="hidden" id="gpt_model" value="" />

                            <!-- FETCH GPT MODELS Button -->
                            <button type="button" class="btn btn-secondary" id="fetch_gpt_models_btn">
                                Fetch GPT Models
                            </button>
                        </div>
                        <!-- SHOW ADVANCED for GPT (API Version, etc.) -->
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                           data-bs-target="#advancedGptFields" aria-expanded="false" aria-controls="advancedGptFields">
                           Show Advanced
                        </a>
                        <div class="collapse" id="advancedGptFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_gpt_api_version" class="form-label">
                                        Azure OpenAI GPT API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_gpt_api_version"
                                           name="azure_openai_gpt_api_version"
                                           value="{{ settings.azure_openai_gpt_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /CHANGE -->

                <!-- CHANGE: APIM-specific fields are shown ONLY if APIM is enabled -->
                <div id="apim_gpt_settings" class="card p-3 mb-3"
                     {% if not settings.enable_gpt_apim %}style="display: none;"{% endif %}>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_endpoint" class="form-label">Azure APIM Endpoint</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_endpoint"
                               name="azure_apim_gpt_endpoint"
                               value="{{ settings.azure_apim_gpt_endpoint or '' }}">
                    </div>   
                    <div class="mb-3">
                        <label for="azure_apim_gpt_api_version" class="form-label">Azure APIM API Version</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_api_version"
                               name="azure_apim_gpt_api_version"
                               value="{{ settings.azure_apim_gpt_api_version or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_deployment" class="form-label">Azure APIM Deployment</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_deployment"
                               name="azure_apim_gpt_deployment"
                               value="{{ settings.azure_apim_gpt_deployment or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_subscription_key" class="form-label">Azure APIM Subscription Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure_apim_gpt_subscription_key"
                                   name="azure_apim_gpt_subscription_key"
                                   value="{{ settings.azure_apim_gpt_subscription_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary" id="toggle_azure_apim_gpt_subscription_key">Show</button>
                        </div>
                    </div>                   
                </div>
                <!-- /CHANGE -->

                <!-- Test GPT Button -->
                <button type="button" class="btn btn-secondary" id="test_gpt_button">
                    Test GPT Connection
                </button>
                <div id="test_gpt_result" class="mt-2"></div>
            </div>

            <!-- EMBEDDINGS TAB -->
            <div class="tab-pane fade" id="embeddings" role="tabpanel" aria-labelledby="embeddings-tab">
                <p class="text-muted">
                    Configure your embeddings settings. These are used for semantic search, knowledge-base lookups, etc.
                </p>

                <!-- CHANGE: Enable APIM switch at the top of the Embeddings tab -->
                <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" id="enable_embedding_apim" name="enable_embedding_apim"
                           {% if settings.enable_embedding_apim %}checked{% endif %}>
                    <label class="form-check-label" for="enable_embedding_apim">Enable APIM</label>
                </div>
                <!-- /CHANGE -->

                <!-- CHANGE: Wrap non-APIM fields for Embeddings -->
                <div id="non_apim_embedding_settings" {% if settings.enable_embedding_apim %}style="display: none;"{% endif %}>
                    <div class="card p-3 mb-3">
                        <div class="mb-3">
                            <label for="azure_openai_embedding_endpoint" class="form-label">
                                Azure OpenAI Embedding Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_embedding_endpoint"
                                   name="azure_openai_embedding_endpoint"
                                   value="{{ settings.azure_openai_embedding_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_embedding_authentication_type"
                                    name="azure_openai_embedding_authentication_type">
                                <option value="key"
                                    {% if settings.azure_openai_embedding_authentication_type=='key' %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity"
                                    {% if settings.azure_openai_embedding_authentication_type=='managed_identity' %}selected{% endif %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_subscription_id" class="form-label">Subscription ID</label>
                            <input type="text" class="form-control" id="azure_openai_embedding_subscription_id"
                                   name="azure_openai_embedding_subscription_id"
                                   value="{{ settings.azure_openai_embedding_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_embedding_resource_group"
                                   name="azure_openai_embedding_resource_group"
                                   value="{{ settings.azure_openai_embedding_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="embedding_key_container"
                             {% if settings.azure_openai_embedding_authentication_type != 'key' %}style="display: none;"{% endif %}>
                            <label for="azure_openai_embedding_key" class="form-label">Azure OpenAI Embedding Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_embedding_key"
                                       name="azure_openai_embedding_key"
                                       value="{{ settings.azure_openai_embedding_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary" id="toggle_embedding_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="embedding_models_list" class="mt-2 mb-3">
                                <!-- Dynamically show the "all" models returned from /api/models/embedding -->
                            </div>
                            <!-- Hidden input that will store the final "selected" Embedding JSON -->
                            <input type="hidden" name="embedding_model_json" id="embedding_model_json" />

                            <!-- Also hidden input for the actual selected deployment name -->
                            <input type="hidden" id="embedding_model" value="" />

                            <!-- FETCH Embedding MODELS Button -->
                            <button type="button" class="btn btn-secondary" id="fetch_embedding_models_btn">
                                Fetch Embedding Models
                            </button>
                        </div>
                        <!-- SHOW ADVANCED for Embeddings -->
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                           data-bs-target="#advancedEmbeddingsFields" aria-expanded="false"
                           aria-controls="advancedEmbeddingsFields">
                           Show Advanced
                        </a>
                        <div class="collapse" id="advancedEmbeddingsFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_embedding_api_version" class="form-label">
                                        Azure OpenAI Embedding API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_embedding_api_version"
                                           name="azure_openai_embedding_api_version"
                                           value="{{ settings.azure_openai_embedding_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /CHANGE -->

                <!-- CHANGE: APIM Embeddings fields -->
                <div id="apim_embedding_settings" class="card p-3 mb-3"
                     {% if not settings.enable_embedding_apim %}style="display: none;"{% endif %}>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_endpoint" class="form-label">Azure APIM Endpoint</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_endpoint"
                               name="azure_apim_embedding_endpoint"
                               value="{{ settings.azure_apim_embedding_endpoint or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_api_version" class="form-label">Azure APIM API Version</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_api_version"
                               name="azure_apim_embedding_api_version"
                               value="{{ settings.azure_apim_embedding_api_version or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_deployment" class="form-label">Azure APIM Deployment</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_deployment"
                               name="azure_apim_embedding_deployment"
                               value="{{ settings.azure_apim_embedding_deployment or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_subscription_key" class="form-label">Azure APIM Subscription Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure_apim_embedding_subscription_key"
                                   name="azure_apim_embedding_subscription_key"
                                   value="{{ settings.azure_apim_embedding_subscription_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary" id="toggle_azure_apim_embedding_subscription_key">Show</button>
                        </div>
                    </div>                   
                </div>
                <!-- /CHANGE -->

                <!-- Test Embeddings Button -->
                <button type="button" class="btn btn-secondary" id="test_embedding_button">
                    Test Embeddings Connection
                </button>
                <div id="test_embedding_result" class="mt-2"></div>
            </div>

            <!-- IMAGE GENERATION TAB -->
            <div class="tab-pane fade" id="image-gen" role="tabpanel" aria-labelledby="image-gen-tab">
                <p class="text-muted">
                    Configure image generation settings. Enable/disable, set endpoints, and choose a model.
                </p>

                <!-- Existing "Enable Image Generation" toggle -->
                <div class="form-group form-check form-switch mb-3">
                    <input type="checkbox" class="form-check-input" id="enable_image_generation"
                           name="enable_image_generation" 
                           {% if settings.enable_image_generation %}checked{% endif %}>
                    <label class="form-check-label ms-2" for="enable_image_generation">
                        Enable Image Generation
                    </label>
                </div>
                <div id="image_gen_settings" 
                     {% if not settings.enable_image_generation %}style="display: none;"{% endif %}>
                     
                    <!-- CHANGE: Move "Enable APIM" to top of the image generation tab content -->
                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" id="enable_image_gen_apim" name="enable_image_gen_apim"
                               {% if settings.enable_image_gen_apim %}checked{% endif %}>
                        <label class="form-check-label" for="enable_image_gen_apim">Enable APIM</label>
                    </div>
                    <!-- /CHANGE -->

                    <!-- CHANGE: Wrap non-APIM image generation fields -->
                    <div id="non_apim_image_gen_settings" {% if settings.enable_image_gen_apim %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label for="azure_openai_image_gen_endpoint" class="form-label">
                                Azure OpenAI Image Generation Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_image_gen_endpoint"
                                   name="azure_openai_image_gen_endpoint"
                                   value="{{ settings.azure_openai_image_gen_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_image_gen_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_image_gen_authentication_type"
                                    name="azure_openai_image_gen_authentication_type">
                                <option value="key" 
                                    {% if settings.azure_openai_image_gen_authentication_type=='key' %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity" 
                                    {% if settings.azure_openai_image_gen_authentication_type=='managed_identity' %}selected{% endif %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_image_gen_subscription_id" class="form-label">Subscription ID</label>
                            <input type="text" class="form-control" id="azure_openai_image_gen_subscription_id"
                                   name="azure_openai_image_gen_subscription_id"
                                   value="{{ settings.azure_openai_image_gen_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_image_gen_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_image_gen_resource_group"
                                   name="azure_openai_image_gen_resource_group"
                                   value="{{ settings.azure_openai_image_gen_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="image_gen_key_container"
                             {% if settings.azure_openai_image_gen_authentication_type != 'key' %}style="display: none;"{% endif %}>
                            <label for="azure_openai_image_gen_key" class="form-label">Azure OpenAI Image Generation Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_image_gen_key"
                                       name="azure_openai_image_gen_key"
                                       value="{{ settings.azure_openai_image_gen_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary" id="toggle_image_gen_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="image_models_list" class="mt-2 mb-3">
                                <!-- Dynamically show the "all" models returned from /api/models/embedding -->
                            </div>
                            <!-- Hidden input that will store the final "selected" model JSON -->
                            <input type="hidden" name="image_gen_model_json" id="image_gen_model_json" />

                            <!-- Also hidden input for the actual selected deployment name -->
                            <input type="hidden" id="image_gen_model" value="" />

                            <!-- FETCH Image Generation MODELS Button -->
                            <button type="button" class="btn btn-secondary" id="fetch_image_models_btn">
                                Fetch Image Generation Models
                            </button>
                        </div>
                        <!-- SHOW ADVANCED for Image Gen (API Version, etc.) -->
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                           data-bs-target="#advancedImageGenFields" aria-expanded="false"
                           aria-controls="advancedImageGenFields">
                           Show Advanced
                        </a>
                        <div class="collapse" id="advancedImageGenFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_image_gen_api_version" class="form-label">
                                        Azure OpenAI Image Gen API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_image_gen_api_version"
                                           name="azure_openai_image_gen_api_version"
                                           value="{{ settings.azure_openai_image_gen_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /CHANGE -->

                    <!-- CHANGE: APIM fields for Image Generation -->
                    <div id="apim_image_gen_settings" class="card p-3 mb-3"
                         {% if not settings.enable_image_gen_apim %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_endpoint" class="form-label">Azure APIM Endpoint</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_endpoint"
                                   name="azure_apim_image_gen_endpoint"
                                   value="{{ settings.azure_apim_image_gen_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_api_version" class="form-label">Azure APIM API Version</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_api_version"
                                   name="azure_apim_image_gen_api_version"
                                   value="{{ settings.azure_apim_image_gen_api_version or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_deployment" class="form-label">Azure APIM Deployment</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_deployment"
                                   name="azure_apim_image_gen_deployment"
                                   value="{{ settings.azure_apim_image_gen_deployment or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_subscription_key" class="form-label">Azure APIM Subscription Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_apim_image_gen_subscription_key"
                                       name="azure_apim_image_gen_subscription_key"
                                       value="{{ settings.azure_apim_image_gen_subscription_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary" id="toggle_azure_apim_image_gen_subscription_key">Show</button>
                            </div>
                        </div>                   
                    </div>
                    <!-- /CHANGE -->
                </div>

                <!-- Test Image Connection Button -->
                <button type="button" class="btn btn-secondary mt-3" id="test_image_button">
                    Test Image Connection
                </button>
                <div id="test_image_result" class="mt-2"></div>
            </div>

            <!-- WEB SEARCH TAB -->
            <div class="tab-pane fade" id="web-search" role="tabpanel" aria-labelledby="web-search-tab">
                <p class="text-muted">
                    Configure Bing Web Search. Enable or disable web search capabilities and set the API key.
                </p>
                <div class="card p-3">
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" id="enable_web_search" name="enable_web_search"
                               {% if settings.enable_web_search %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="enable_web_search">
                            Enable Web Search
                        </label>
                    </div>
                    <div id="web_search_settings" 
                         {% if not settings.enable_web_search %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label for="bing_search_key" class="form-label">Bing Search Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="bing_search_key"
                                       name="bing_search_key"
                                       value="{{ settings.bing_search_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary" id="toggle_bing_search_key">Show</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXTERNAL APIS TAB -->
            <div class="tab-pane fade" id="external-apis" role="tabpanel" aria-labelledby="external-apis-tab">
                <p class="text-muted">
                    Enable and configure external APIs for chunking and embedding functionality.
                </p>
                <div class="card p-3">
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" id="use_external_apis" name="use_external_apis"
                               {% if settings.use_external_apis %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="use_external_apis">
                            Use External APIs for Chunking and Embedding
                        </label>
                    </div>
                    <div id="external_apis_settings" 
                         {% if not settings.use_external_apis %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label for="external_chunking_api" class="form-label">
                                Chunking API Endpoint
                            </label>
                            <input type="text" class="form-control" id="external_chunking_api"
                                   name="external_chunking_api"
                                   value="{{ settings.external_chunking_api }}">
                        </div>
                        <div class="mb-3">
                            <label for="external_embedding_api" class="form-label">
                                Embedding API Endpoint
                            </label>
                            <input type="text" class="form-control" id="external_embedding_api"
                                   name="external_embedding_api"
                                   value="{{ settings.external_embedding_api }}">
                        </div>
                        <button type="button" class="btn btn-secondary mb-3" id="test_connection_button">
                            Test Connection
                        </button>
                        <div id="test_connection_result"></div>
                    </div>
                </div>
            </div>

            <!-- OTHER TAB -->
            <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="other-tab">
                <p class="text-muted">
                    Miscellaneous or rarely changed settings, such as maximum file size, conversation history limits, etc.
                </p>
                <div class="card p-3 mb-3">
                    <div class="mb-3">
                        <label for="max_file_size_mb" class="form-label">Maximum File Size (MB)</label>
                        <input type="number" class="form-control" id="max_file_size_mb"
                               name="max_file_size_mb"
                               value="{{ settings.max_file_size_mb }}">
                    </div>
                    <div class="mb-3">
                        <label for="conversation_history_limit" class="form-label">
                            Conversation History Limit
                        </label>
                        <input type="number" class="form-control" id="conversation_history_limit"
                               name="conversation_history_limit"
                               value="{{ settings.conversation_history_limit }}">
                    </div>
                    <div class="mb-3">
                        <label for="default_system_prompt" class="form-label">Default System Prompt</label>
                        <textarea class="form-control" id="default_system_prompt"
                                  name="default_system_prompt" rows="5">{{ settings.default_system_prompt }}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Put Jinja variables in a global or window variable
  window.gptSelected = JSON.parse('{{ settings.gpt_model.selected|tojson()|safe }}');
  window.gptAll = JSON.parse('{{ settings.gpt_model.all|tojson()|safe }}');

  window.embeddingSelected = JSON.parse('{{ settings.embedding_model.selected|tojson()|safe }}');
  window.embeddingAll = JSON.parse('{{ settings.embedding_model.all|tojson()|safe }}');

  window.imageSelected = JSON.parse('{{ settings.image_gen_model.selected|tojson()|safe }}');
  window.imageAll = JSON.parse('{{ settings.image_gen_model.all|tojson()|safe }}');
</script>

<!-- Then load the external file, which can read from the window.* variables -->
<script src="{{ url_for('static', filename='js/admin_settings.js') }}"></script>
{% endblock %}
