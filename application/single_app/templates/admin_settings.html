<!-- templates/admin_settings.html -->

{% extends "base.html" %}
{% block title %}
    Admin Settings - {{ app_settings.app_title }}
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.css">
{% endblock %}

{% block content %}

<div class="container">
    <h2>Admin Settings</h2>
    <form method="post" enctype="multipart/form-data">
        <p class="text-muted">Use this form to configure the administrative settings for your application.</p>
        <p class="text-muted">Version: {{ config['VERSION'] }}</p>
        <button type="submit" class="btn btn-primary mt-3 mb-3">Save Settings</button>

        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="adminSettingsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general"
                    type="button" role="tab" aria-controls="general" aria-selected="true">
                    General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gpt-tab" data-bs-toggle="tab" data-bs-target="#gpt" type="button"
                    role="tab" aria-controls="gpt" aria-selected="false">
                    GPT
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="embeddings-tab" data-bs-toggle="tab" data-bs-target="#embeddings"
                    type="button" role="tab" aria-controls="embeddings" aria-selected="false">
                    Embeddings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="image-gen-tab" data-bs-toggle="tab" data-bs-target="#image-gen"
                    type="button" role="tab" aria-controls="image-gen" aria-selected="false">
                    Image Generation
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="Workspaces" data-bs-toggle="tab" data-bs-target="#workspaces" type="button"
                    role="tab" aria-controls="workspaces" aria-selected="false">
                    Workspaces
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety"
                    type="button" role="tab" aria-controls="safety" aria-selected="false">
                    Safety
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-extract-tab" data-bs-toggle="tab" data-bs-target="#search-extract"
                    type="button" role="tab" aria-controls="search-extract" aria-selected="false">
                    Search and Extract
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button"
                    role="tab" aria-controls="other" aria-selected="false">
                    Other
                </button>
            </li>
        </ul>

        <!-- Tab Panes -->
        <div class="tab-content mt-3" id="adminSettingsTabContent">

            <!-- GENERAL TAB -->
            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                <p class="text-muted">
                    Configure general application settings, including the applicationâ€™s title, logo, and landing page text.
                </p>
                <div class="card p-3 mb-3">
                    <div class="mb-3">
                        <label for="app_title" class="form-label">Application Title</label>
                        <input type="text" class="form-control" id="app_title" name="app_title" value="{{ settings.app_title }}">
                    </div>
                    <h5 class="mt-3">Logo Settings</h5>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" id="show_logo" name="show_logo"
                            {% if settings.show_logo %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="show_logo">Show Logo</label>
                    </div>
                    <div class="form-group mb-3">
                        <label for="logo_file">Upload Custom Logo</label>
                        <input type="file" class="form-control" name="logo_file" id="logo_file" accept=".png,.jpg,.jpeg">
                    </div>
                </div>

                <!-- Landing Page Text card -->
                <div class="card p-3">
                    <label class="form-label fw-bold">Landing Page Text (Markdown)</label>
                    <p class="text-muted mb-1">You can either edit the text in a Markdown editor or switch to a preview mode.</p>

                    <!-- Toggle for enabling the editor vs. viewing Markdown preview -->
                    <div class="form-check form-switch mb-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="toggleLandingPageEditor"
                            name="enable_landing_page_editor"
                            {% if settings.enable_landing_page_editor %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="toggleLandingPageEditor">
                            Enable Markdown Editor
                        </label>
                    </div>

                    <!-- The text area that SimpleMDE will attach to -->
                    <div id="landingPageEditorContainer" style="display: none;">
                        <textarea
                            class="form-control"
                            id="landing_page_text_editor"
                            name="landing_page_text"
                            rows="5"
                        >{{ settings.landing_page_text }}</textarea>
                    </div>

                    <!-- A read-only container for rendered markdown preview -->
                    <div
                        id="landingPageMarkdownPreview"
                        class="p-2 border rounded"
                        style="white-space: pre-wrap; display: none;"
                    ></div>
                </div>
            </div>

            <!-- GPT TAB -->
            <div class="tab-pane fade" id="gpt" role="tabpanel" aria-labelledby="gpt-tab">
                <p class="text-muted">
                    Configure your GPT model settings. These are used for generating AI text responses.
                </p>

                <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" id="enable_gpt_apim" name="enable_gpt_apim" {%
                        if settings.enable_gpt_apim %}checked{% endif %}>
                    <label class="form-check-label" for="enable_gpt_apim">Use APIM instead of direct to Azure OpenAI
                        endpoint.</label>
                </div>

                <div id="non_apim_gpt_settings" {% if settings.enable_gpt_apim %}style="display: none;" {% endif %}>
                    <div class="card p-3 mb-3">
                        <div class="mb-3">
                            <label for="azure_openai_gpt_endpoint" class="form-label">
                                Azure OpenAI GPT Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_gpt_endpoint"
                                name="azure_openai_gpt_endpoint" value="{{ settings.azure_openai_gpt_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_gpt_authentication_type"
                                name="azure_openai_gpt_authentication_type">
                                <option value="key" {% if settings.azure_openai_gpt_authentication_type=='key'
                                    %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity" {% if
                                    settings.azure_openai_gpt_authentication_type=='managed_identity' %}selected{% endif
                                    %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_subscription_id" class="form-label">Subscription ID</label>
                            <input type="text" class="form-control" id="azure_openai_gpt_subscription_id"
                                name="azure_openai_gpt_subscription_id"
                                value="{{ settings.azure_openai_gpt_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_gpt_resource_group"
                                name="azure_openai_gpt_resource_group"
                                value="{{ settings.azure_openai_gpt_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="gpt_key_container" {% if settings.azure_openai_gpt_authentication_type
                            !='key' %}style="display: none;" {% endif %}>
                            <label for="azure_openai_gpt_key" class="form-label">Azure OpenAI GPT Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_gpt_key"
                                    name="azure_openai_gpt_key" value="{{ settings.azure_openai_gpt_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_gpt_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="gpt_models_list" class="mt-2 mb-3">
                                <!-- Dynamically show the "all" models returned from /api/models/gpt -->
                            </div>
                            <!-- Hidden input that will store the final "selected" GPT JSON -->
                            <input type="hidden" name="gpt_model_json" id="gpt_model_json" />

                            <!-- Also hidden input for the actual selected deployment name -->
                            <input type="hidden" id="gpt_model" value="" />

                            <button type="button" class="btn btn-secondary" id="fetch_gpt_models_btn">
                                Fetch GPT Models
                            </button>
                        </div>
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                            data-bs-target="#advancedGptFields" aria-expanded="false" aria-controls="advancedGptFields">
                            Show Advanced
                        </a>
                        <div class="collapse" id="advancedGptFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_gpt_api_version" class="form-label">
                                        Azure OpenAI GPT API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_gpt_api_version"
                                        name="azure_openai_gpt_api_version"
                                        value="{{ settings.azure_openai_gpt_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="apim_gpt_settings" class="card p-3 mb-3" {% if not settings.enable_gpt_apim
                    %}style="display: none;" {% endif %}>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_endpoint" class="form-label">Azure APIM Endpoint</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_endpoint"
                            name="azure_apim_gpt_endpoint" value="{{ settings.azure_apim_gpt_endpoint or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_api_version" class="form-label">Azure APIM API Version</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_api_version"
                            name="azure_apim_gpt_api_version" value="{{ settings.azure_apim_gpt_api_version or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_deployment" class="form-label">Azure APIM Deployment</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_deployment"
                            name="azure_apim_gpt_deployment" value="{{ settings.azure_apim_gpt_deployment or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_subscription_key" class="form-label">Azure APIM Subscription
                            Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure_apim_gpt_subscription_key"
                                name="azure_apim_gpt_subscription_key"
                                value="{{ settings.azure_apim_gpt_subscription_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary"
                                id="toggle_azure_apim_gpt_subscription_key">Show</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary" id="test_gpt_button">
                    Test GPT Connection
                </button>
                <div id="test_gpt_result" class="mt-2"></div>
            </div>

            <!-- EMBEDDINGS TAB -->
            <div class="tab-pane fade" id="embeddings" role="tabpanel" aria-labelledby="embeddings-tab">
                <p class="text-muted">
                    Configure your embeddings settings. These are used for semantic search, knowledge-base lookups, etc.
                </p>

                <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" id="enable_embedding_apim"
                        name="enable_embedding_apim" {% if settings.enable_embedding_apim %}checked{% endif %}>
                    <label class="form-check-label" for="enable_embedding_apim">Use APIM instead of direct to Azure
                        OpenAI endpoint.</label>
                </div>

                <div id="non_apim_embedding_settings" {% if settings.enable_embedding_apim %}style="display: none;" {%
                    endif %}>
                    <div class="card p-3 mb-3">
                        <div class="mb-3">
                            <label for="azure_openai_embedding_endpoint" class="form-label">
                                Azure OpenAI Embedding Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_embedding_endpoint"
                                name="azure_openai_embedding_endpoint"
                                value="{{ settings.azure_openai_embedding_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_embedding_authentication_type"
                                name="azure_openai_embedding_authentication_type">
                                <option value="key" {% if settings.azure_openai_embedding_authentication_type=='key'
                                    %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity" {% if
                                    settings.azure_openai_embedding_authentication_type=='managed_identity' %}selected{%
                                    endif %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_subscription_id" class="form-label">Subscription
                                ID</label>
                            <input type="text" class="form-control" id="azure_openai_embedding_subscription_id"
                                name="azure_openai_embedding_subscription_id"
                                value="{{ settings.azure_openai_embedding_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_embedding_resource_group"
                                name="azure_openai_embedding_resource_group"
                                value="{{ settings.azure_openai_embedding_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="embedding_key_container" {% if
                            settings.azure_openai_embedding_authentication_type !='key' %}style="display: none;" {%
                            endif %}>
                            <label for="azure_openai_embedding_key" class="form-label">Azure OpenAI Embedding
                                Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_embedding_key"
                                    name="azure_openai_embedding_key"
                                    value="{{ settings.azure_openai_embedding_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_embedding_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="embedding_models_list" class="mt-2 mb-3">
                                <!-- Dynamically show the "all" models returned from /api/models/embedding -->
                            </div>
                            <!-- Hidden input that will store the final "selected" Embedding JSON -->
                            <input type="hidden" name="embedding_model_json" id="embedding_model_json" />

                            <!-- Also hidden input for the actual selected deployment name -->
                            <input type="hidden" id="embedding_model" value="" />

                            <!-- FETCH Embedding MODELS Button -->
                            <button type="button" class="btn btn-secondary" id="fetch_embedding_models_btn">
                                Fetch Embedding Models
                            </button>
                        </div>
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                            data-bs-target="#advancedEmbeddingsFields" aria-expanded="false"
                            aria-controls="advancedEmbeddingsFields">
                            Show Advanced
                        </a>
                        <div class="collapse" id="advancedEmbeddingsFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_embedding_api_version" class="form-label">
                                        Azure OpenAI Embedding API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_embedding_api_version"
                                        name="azure_openai_embedding_api_version"
                                        value="{{ settings.azure_openai_embedding_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="apim_embedding_settings" class="card p-3 mb-3" {% if not settings.enable_embedding_apim
                    %}style="display: none;" {% endif %}>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_endpoint" class="form-label">Azure APIM Endpoint</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_endpoint"
                            name="azure_apim_embedding_endpoint"
                            value="{{ settings.azure_apim_embedding_endpoint or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_api_version" class="form-label">Azure APIM API Version</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_api_version"
                            name="azure_apim_embedding_api_version"
                            value="{{ settings.azure_apim_embedding_api_version or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_deployment" class="form-label">Azure APIM Deployment</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_deployment"
                            name="azure_apim_embedding_deployment"
                            value="{{ settings.azure_apim_embedding_deployment or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_subscription_key" class="form-label">Azure APIM Subscription
                            Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure_apim_embedding_subscription_key"
                                name="azure_apim_embedding_subscription_key"
                                value="{{ settings.azure_apim_embedding_subscription_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary"
                                id="toggle_azure_apim_embedding_subscription_key">Show</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary" id="test_embedding_button">
                    Test Embeddings Connection
                </button>
                <div id="test_embedding_result" class="mt-2"></div>
            </div>

            <!-- IMAGE GENERATION TAB -->
            <div class="tab-pane fade" id="image-gen" role="tabpanel" aria-labelledby="image-gen-tab">
                <p class="text-muted">
                    Configure image generation settings. Enable/disable, set endpoints, and choose a model.
                </p>

                <div class="form-group form-check form-switch mb-3">
                    <input type="checkbox" class="form-check-input" id="enable_image_generation"
                        name="enable_image_generation" {% if settings.enable_image_generation %}checked{% endif %}>
                    <label class="form-check-label ms-2" for="enable_image_generation">
                        Enable Image Generation
                    </label>
                </div>
                <div id="image_gen_settings" {% if not settings.enable_image_generation %}style="display: none;" {%
                    endif %}>

                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" id="enable_image_gen_apim"
                            name="enable_image_gen_apim" {% if settings.enable_image_gen_apim %}checked{% endif %}>
                        <label class="form-check-label" for="enable_image_gen_apim">Use APIM instead of direct to Azure
                            OpenAI endpoint.</label>
                    </div>

                    <div id="non_apim_image_gen_settings" {% if settings.enable_image_gen_apim %}style="display: none;"
                        {% endif %}>
                        <div class="card p-3 mb-3">
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_endpoint" class="form-label">
                                    Azure OpenAI Image Generation Endpoint
                                </label>
                                <input type="text" class="form-control" id="azure_openai_image_gen_endpoint"
                                    name="azure_openai_image_gen_endpoint"
                                    value="{{ settings.azure_openai_image_gen_endpoint or '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="azure_openai_image_gen_authentication_type"
                                    name="azure_openai_image_gen_authentication_type">
                                    <option value="key" {% if settings.azure_openai_image_gen_authentication_type=='key'
                                        %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if
                                        settings.azure_openai_image_gen_authentication_type=='managed_identity'
                                        %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_subscription_id" class="form-label">Subscription
                                    ID</label>
                                <input type="text" class="form-control" id="azure_openai_image_gen_subscription_id"
                                    name="azure_openai_image_gen_subscription_id"
                                    value="{{ settings.azure_openai_image_gen_subscription_id or '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_resource_group" class="form-label">Resource
                                    Group</label>
                                <input type="text" class="form-control" id="azure_openai_image_gen_resource_group"
                                    name="azure_openai_image_gen_resource_group"
                                    value="{{ settings.azure_openai_image_gen_resource_group or '' }}">
                            </div>
                            <div class="mb-3" id="image_gen_key_container" {% if
                                settings.azure_openai_image_gen_authentication_type !='key' %}style="display: none;" {%
                                endif %}>
                                <label for="azure_openai_image_gen_key" class="form-label">Azure OpenAI Image Generation
                                    Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="azure_openai_image_gen_key"
                                        name="azure_openai_image_gen_key"
                                        value="{{ settings.azure_openai_image_gen_key or '' }}">
                                    <button type="button" class="btn btn-outline-secondary"
                                        id="toggle_image_gen_key">Show</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div id="image_models_list" class="mt-2 mb-3">
                                    <!-- Dynamically show the "all" models returned from /api/models/embedding -->
                                </div>
                                <!-- Hidden input that will store the final "selected" model JSON -->
                                <input type="hidden" name="image_gen_model_json" id="image_gen_model_json" />

                                <!-- Also hidden input for the actual selected deployment name -->
                                <input type="hidden" id="image_gen_model" value="" />

                                <!-- FETCH Image Generation MODELS Button -->
                                <button type="button" class="btn btn-secondary" id="fetch_image_models_btn">
                                    Fetch Image Generation Models
                                </button>
                            </div>
                            <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                                data-bs-target="#advancedImageGenFields" aria-expanded="false"
                                aria-controls="advancedImageGenFields">
                                Show Advanced
                            </a>
                            <div class="collapse" id="advancedImageGenFields">
                                <div class="card card-body mt-2">
                                    <div class="mb-3">
                                        <label for="azure_openai_image_gen_api_version" class="form-label">
                                            Azure OpenAI Image Gen API Version
                                        </label>
                                        <input type="text" class="form-control" id="azure_openai_image_gen_api_version"
                                            name="azure_openai_image_gen_api_version"
                                            value="{{ settings.azure_openai_image_gen_api_version or '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="apim_image_gen_settings" class="card p-3 mb-3" {% if not settings.enable_image_gen_apim
                        %}style="display: none;" {% endif %}>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_endpoint" class="form-label">Azure APIM Endpoint</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_endpoint"
                                name="azure_apim_image_gen_endpoint"
                                value="{{ settings.azure_apim_image_gen_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_api_version" class="form-label">Azure APIM API
                                Version</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_api_version"
                                name="azure_apim_image_gen_api_version"
                                value="{{ settings.azure_apim_image_gen_api_version or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_deployment" class="form-label">Azure APIM
                                Deployment</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_deployment"
                                name="azure_apim_image_gen_deployment"
                                value="{{ settings.azure_apim_image_gen_deployment or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_subscription_key" class="form-label">Azure APIM
                                Subscription Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_apim_image_gen_subscription_key"
                                    name="azure_apim_image_gen_subscription_key"
                                    value="{{ settings.azure_apim_image_gen_subscription_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_azure_apim_image_gen_subscription_key">Show</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary mt-3" id="test_image_button">
                    Test Image Connection
                </button>
                <div id="test_image_result" class="mt-2"></div>
            </div>

            <!-- WORKSPACES TAB -->
            <div class="tab-pane fade" id="workspaces" role="tabpanel" aria-labelledby="workspaces-tab">
                <p class="text-muted">
                    Configure workspace settings. Enable or disable workspaces and set the default workspace.
                </p>
                
                <!-- Card for "Enable Your Workspace" -->
                <div class="card mb-3 p-3">
                    <h5>Enable Your Workspace</h5>
                    <p class="text-muted">
                        Turn this on to allow access and management of your personal workspace.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" 
                            class="form-check-input" 
                            id="enable_user_workspace"
                            name="enable_user_workspace"
                            {% if settings.enable_user_workspace %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="enable_user_workspace">
                            Enable Your Workspace
                        </label>
                    </div>
                </div>

                <!-- Card for "Enable My Groups (includes Group Workspaces)" -->
                <div class="card p-3">
                    <h5>Enable My Groups (includes Group Workspaces)</h5>
                    <p class="text-muted">
                        Turn this on to allow access and management of group workspaces, as well as group collaboration.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" 
                            class="form-check-input" 
                            id="enable_group_workspaces"
                            name="enable_group_workspaces"
                            {% if settings.enable_group_workspaces %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="enable_group_workspaces">
                            Enable My Groups (includes Group Workspaces)
                        </label>
                    </div>
                </div>
            </div>


            <!-- SAFETY TAB -->
            <div class="tab-pane fade" id="safety" role="tabpanel" aria-labelledby="safety-tab">
                <p class="text-muted">
                    Configure content safety, archiving, and user feedback settings. If Content Safety is enabled, user
                    messages will be sent to the safety endpoint for analysis. If User Feedback is enabled, users will see
                    thumbs up/down to provide feedback on AI responses.
                </p>
                <div class="card p-3 mb-3">
                    <!-- ENABLE CONTENT SAFETY -->
                    <h5>Content Safety</h5>
                    <p class="text-muted">Enable content safety to filter out inappropriate content.</p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_content_safety"
                            name="enable_content_safety"
                            {% if settings.enable_content_safety %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_content_safety">
                            Enable Content Safety
                        </label>
                    </div>

                    <!-- CONTENT SAFETY DETAILS - Shown/Hidden based on toggle -->
                    <div id="content_safety_settings"
                         {% if not settings.enable_content_safety %}style="display: none;"{% endif %}>
                        
                        <!-- APIM toggle for Content Safety -->
                        <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                            <input
                                type="checkbox"
                                class="form-check-input me-2"
                                id="enable_content_safety_apim"
                                name="enable_content_safety_apim"
                                {% if settings.enable_content_safety_apim %}checked{% endif %}
                            >
                            <label class="form-check-label" for="enable_content_safety_apim">
                                Use APIM instead of direct Content Safety endpoint
                            </label>
                        </div>

                        <!-- Non-APIM fields (hidden if APIM is enabled) -->
                        <div id="non_apim_content_safety_settings"
                             {% if settings.enable_content_safety_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="content_safety_endpoint" class="form-label">
                                    Content Safety Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="content_safety_endpoint"
                                    name="content_safety_endpoint"
                                    value="{{ settings.content_safety_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="content_safety_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="content_safety_authentication_type" name="content_safety_authentication_type">
                                    <option value="key" {% if settings.content_safety_authentication_type=='key' %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if settings.content_safety_authentication_type=='managed_identity' %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3" id="content_safety_key_container" {% if settings.content_safety_authentication_type !='key' %}style="display: none;"{% endif %}>
                                <label for="content_safety_key" class="form-label">
                                    Content Safety Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="content_safety_key"
                                        name="content_safety_key"
                                        value="{{ settings.content_safety_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_content_safety_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- APIM fields (hidden if APIM is disabled) -->
                        <div id="apim_content_safety_settings"
                             {% if not settings.enable_content_safety_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_content_safety_endpoint" class="form-label">
                                    Azure APIM Content Safety Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_content_safety_endpoint"
                                    name="azure_apim_content_safety_endpoint"
                                    value="{{ settings.azure_apim_content_safety_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_content_safety_subscription_key" class="form-label">
                                    Azure APIM Content Safety Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_content_safety_subscription_key"
                                        name="azure_apim_content_safety_subscription_key"
                                        value="{{ settings.azure_apim_content_safety_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_content_safety_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary mt-3" id="test_safety_button">
                            Test Safety Connection
                        </button>
                        <div id="test_safety_result" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- ENABLE USER FEEDBACK -->
                <div class="card p-3 mb-3">
                    <h5>User Feedback</h5>
                    <p class="text-muted">Enable user feedback (thumbs up/down) for AI responses.</p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_user_feedback"
                            name="enable_user_feedback"
                            {% if settings.enable_user_feedback %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_user_feedback">
                            Enable User Feedback (Thumbs Up/Down)
                        </label>
                    </div>
                </div>

                <!-- CONVERSATION ARCHIVING -->
                <div class="card p-3 mb-3">
                    <h5>Conversation Archiving</h5>
                    <p class="text-muted">When enabled, conversation deletions will be archived instead of permanently deleted.</p>
                    <div class="form-group form-check form-switch mb-3">
                        <input 
                            type="checkbox" 
                            class="form-check-input" 
                            id="enable_conversation_archiving" 
                            name="enable_conversation_archiving" 
                            {% if settings.enable_conversation_archiving %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_conversation_archiving">
                            Enable Conversation Archiving
                        </label>
                    </div>
                </div>
            </div>

            <!-- SEARCH AND EXTRACT TAB -->
            <div class="tab-pane fade" id="search-extract" role="tabpanel" aria-labelledby="search-extract-tab">
                <p class="text-muted">
                    Configure Bing Web Search, Azure AI Search, and Document Intelligence settings.
                </p>

                <!-- BING WEB SEARCH -->
                <div class="card p-3 mb-3">
                    <h5>Bing Web Search</h5>
                    <p class="text-muted">
                        Enable Bing Web Search to allow users to search the web for information.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_web_search"
                            name="enable_web_search"
                            {% if settings.enable_web_search %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_web_search">
                            Enable Bing Web Search
                        </label>
                    </div>

                    <!-- Hide Bing fields if not enabled -->
                    <div id="web_search_settings" {% if not settings.enable_web_search %}style="display: none;"{% endif %}>

                        <!-- APIM toggle for Bing Web Search -->
                        <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                            <input
                                type="checkbox"
                                class="form-check-input me-2"
                                id="enable_web_search_apim"
                                name="enable_web_search_apim"
                                {% if settings.enable_web_search_apim %}checked{% endif %}
                            >
                            <label class="form-check-label" for="enable_web_search_apim">
                                Use APIM instead of direct Bing Web Search
                            </label>
                        </div>

                        <!-- Non-APIM fields -->
                        <div id="non_apim_web_search_settings" {% if settings.enable_web_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="bing_search_key" class="form-label">Bing Search Key</label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="bing_search_key"
                                        name="bing_search_key"
                                        value="{{ settings.bing_search_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_bing_search_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- APIM fields -->
                        <div id="apim_web_search_settings" {% if not settings.enable_web_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_web_search_endpoint" class="form-label">
                                    Azure APIM Web Search Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_web_search_endpoint"
                                    name="azure_apim_web_search_endpoint"
                                    value="{{ settings.azure_apim_web_search_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_web_search_subscription_key" class="form-label">
                                    Azure APIM Web Search Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_web_search_subscription_key"
                                        name="azure_apim_web_search_subscription_key"
                                        value="{{ settings.azure_apim_web_search_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_web_search_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary mt-3" id="test_web_search_button">
                            Test Web Search Connection
                        </button>
                        <div id="test_web_search_result" class="mt-2"></div>
                    </div>
                </div>

                <!-- AZURE AI SEARCH -->
                <div class="card p-3 mb-3">
                    <h5>Azure AI Search</h5>
                    <p class="text-muted">
                        Configure Azure AI Search settings.
                    </p>
                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input
                            type="checkbox"
                            class="form-check-input me-2"
                            id="enable_ai_search_apim"
                            name="enable_ai_search_apim"
                            {% if settings.enable_ai_search_apim %}checked{% endif %}
                        >
                        <label class="form-check-label" for="enable_ai_search_apim">
                            Use APIM instead of direct Azure AI Search
                        </label>
                    </div>
                    
                    <div>
                        <!-- Non-APIM fields -->
                        <div id="non_apim_ai_search_settings" {% if settings.enable_ai_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_ai_search_endpoint" class="form-label">Search Endpoint</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_ai_search_endpoint"
                                    name="azure_ai_search_endpoint"
                                    value="{{ settings.azure_ai_search_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_ai_search_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="azure_ai_search_authentication_type" name="azure_ai_search_authentication_type">
                                    <option value="key" {% if settings.azure_ai_search_authentication_type=='key' %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if settings.azure_ai_search_authentication_type=='managed_identity' %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3" id="azure_ai_search_key_container" {% if settings.azure_ai_search_authentication_type !='key' %}style="display: none;"{% endif %}>
                                <label for="azure_ai_search_key" class="form-label">Search Key</label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_ai_search_key"
                                        name="azure_ai_search_key"
                                        value="{{ settings.azure_ai_search_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_search_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- APIM fields -->
                        <div id="apim_ai_search_settings" {% if not settings.enable_ai_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_ai_search_endpoint" class="form-label">
                                    Azure APIM AI Search Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_ai_search_endpoint"
                                    name="azure_apim_ai_search_endpoint"
                                    value="{{ settings.azure_apim_ai_search_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_ai_search_subscription_key" class="form-label">
                                    Azure APIM AI Search Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_ai_search_subscription_key"
                                        name="azure_apim_ai_search_subscription_key"
                                        value="{{ settings.azure_apim_ai_search_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_ai_search_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Make the button the same style as Web Search -->
                        <button 
                            type="button" 
                            class="btn btn-secondary mt-3" 
                            style="width: auto;" 
                            id="test_azure_ai_search_button"
                        >
                            Test Azure AI Search Connection
                        </button>
                        <div id="test_azure_ai_search_result" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- AZURE DOCUMENT INTELLIGENCE (no enable/disable toggle) -->
                <div class="card p-3 mb-3">
                    <h5>Document Intelligence</h5>
                    <p class="text-muted">
                        Configure Azure Document Intelligence settings.
                    </p>
                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input
                            type="checkbox"
                            class="form-check-input me-2"
                            id="enable_document_intelligence_apim"
                            name="enable_document_intelligence_apim"
                            {% if settings.enable_document_intelligence_apim %}checked{% endif %}
                        >
                        <label class="form-check-label" for="enable_document_intelligence_apim">
                            Use APIM instead of direct Document Intelligence endpoint
                        </label>
                    </div>
                    
                    <div>
                        <!-- Non-APIM fields -->
                        <div id="non_apim_document_intelligence_settings" {% if settings.enable_document_intelligence_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_document_intelligence_endpoint" class="form-label">
                                    Document Intelligence Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_document_intelligence_endpoint"
                                    name="azure_document_intelligence_endpoint"
                                    value="{{ settings.azure_document_intelligence_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_document_intelligence_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="azure_document_intelligence_authentication_type" name="azure_document_intelligence_authentication_type">
                                    <option value="key" {% if settings.azure_document_intelligence_authentication_type=='key' %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if settings.azure_document_intelligence_authentication_type=='managed_identity' %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3" id="azure_document_intelligence_key_container" {% if settings.azure_document_intelligence_authentication_type !='key' %}style="display: none;"{% endif %}>
                                <label for="azure_document_intelligence_key" class="form-label">
                                    Document Intelligence Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_document_intelligence_key"
                                        name="azure_document_intelligence_key"
                                        value="{{ settings.azure_document_intelligence_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_docintel_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- APIM fields -->
                        <div id="apim_document_intelligence_settings" {% if not settings.enable_document_intelligence_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_document_intelligence_endpoint" class="form-label">
                                    Azure APIM Document Intelligence Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_document_intelligence_endpoint"
                                    name="azure_apim_document_intelligence_endpoint"
                                    value="{{ settings.azure_apim_document_intelligence_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_document_intelligence_subscription_key" class="form-label">
                                    Azure APIM Document Intelligence Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_document_intelligence_subscription_key"
                                        name="azure_apim_document_intelligence_subscription_key"
                                        value="{{ settings.azure_apim_document_intelligence_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_document_intelligence_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Match the style of the Web Search button -->
                        <button 
                            type="button" 
                            class="btn btn-secondary mt-3" 
                            style="width: auto;" 
                            id="test_azure_doc_intelligence_button"
                        >
                            Test Document Intelligence Connection
                        </button>
                        <div id="test_azure_doc_intelligence_result" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- OTHER TAB -->
            <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="other-tab">
                <p class="text-muted">
                    Miscellaneous or rarely changed settings, such as maximum file size, conversation history limits,
                    etc.
                </p>
                <div class="card p-3 mb-3">
                    <div class="mb-3">
                        <label for="max_file_size_mb" class="form-label">Maximum File Size (MB)</label>
                        <input type="number" class="form-control" id="max_file_size_mb" name="max_file_size_mb"
                            value="{{ settings.max_file_size_mb }}">
                    </div>
                    <div class="mb-3">
                        <label for="conversation_history_limit" class="form-label">
                            Conversation History Limit
                        </label>
                        <input type="number" class="form-control" id="conversation_history_limit"
                            name="conversation_history_limit" value="{{ settings.conversation_history_limit }}">
                    </div>
                    <div class="mb-3">
                        <label for="default_system_prompt" class="form-label">Default System Prompt</label>
                        <textarea class="form-control" id="default_system_prompt" name="default_system_prompt"
                            rows="5">{{ settings.default_system_prompt }}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>

<script>
    // Weâ€™ll store the SimpleMDE instance globally so we can destroy or read its content
    let simplemde = null;

    // Grab references to the toggle, the editor container, and the preview container
    const toggleLandingPageEditor = document.getElementById("toggleLandingPageEditor");
    const landingPageEditorContainer = document.getElementById("landingPageEditorContainer");
    const landingPageMarkdownPreview = document.getElementById("landingPageMarkdownPreview");

    function showEditor() {
        // Show the text area container
        landingPageEditorContainer.style.display = "block";
        // Hide the preview container
        landingPageMarkdownPreview.style.display = "none";

        // If we haven't already created the editor, do so
        if (!simplemde) {
            simplemde = new SimpleMDE({
                element: document.getElementById("landing_page_text_editor"),
                // Optionally add any SimpleMDE config here:
                // placeholder: "Enter your landing page markdown..."
            });
        }
    }

    function showPreview() {
        // Hide the text area container
        landingPageEditorContainer.style.display = "none";
        // Show the preview container
        landingPageMarkdownPreview.style.display = "block";

        // Render the markdown inside the preview container
        if (simplemde) {
            landingPageMarkdownPreview.innerHTML = simplemde.markdown(simplemde.value());
        } else {
            // If for some reason simplemde is null (e.g., user never toggled on?), 
            // just show raw text
            landingPageMarkdownPreview.innerHTML = document.getElementById("landing_page_text_editor").value;
        }
    }

    // Listen for changes on the toggle
    toggleLandingPageEditor.addEventListener("change", () => {
        if (toggleLandingPageEditor.checked) {
            showEditor();
        } else {
            showPreview();
        }
    });

    // On page load, decide which view to show, based on userâ€™s stored setting
    if (toggleLandingPageEditor.checked) {
        showEditor();
    } else {
        showPreview();
    }
</script>

<script>
    // Prepopulate model arrays from server
    window.gptSelected = JSON.parse('{{ settings.gpt_model.selected|tojson()|safe }}');
    window.gptAll = JSON.parse('{{ settings.gpt_model.all|tojson()|safe }}');

    window.embeddingSelected = JSON.parse('{{ settings.embedding_model.selected|tojson()|safe }}');
    window.embeddingAll = JSON.parse('{{ settings.embedding_model.all|tojson()|safe }}');

    window.imageSelected = JSON.parse('{{ settings.image_gen_model.selected|tojson()|safe }}');
    window.imageAll = JSON.parse('{{ settings.image_gen_model.all|tojson()|safe }}');
</script>
<script src="{{ url_for('static', filename='js/admin_settings.js') }}"></script>
{% endblock %}
